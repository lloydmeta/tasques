package saved_objects

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"io"
	"mime/multipart"
	"net/http"
	"strings"

	"github.com/lloydmeta/tasques/internal/config"
	"github.com/lloydmeta/tasques/internal/infra/elasticsearch/common"
)

var ndjson = `{"attributes":{"buildNum":27675,"defaultIndex":".tasques_queue-*"},"id":"7.5.2","references":[],"type":"config","updated_at":"2020-02-27T05:00:09.702Z","version":"WzMwLDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"title":"Tasques description","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques description\",\"type\":\"markdown\",\"params\":{\"fontSize\":12,\"openLinksInNewTab\":false,\"markdown\":\"## Tasques\\n\\nA general purpose, language agnostic background Tasks server backed by Elasticsearch.\\n\\nYou know, for background processing!\"},\"aggs\":[]}"},"id":"eff223e0-4b28-11ea-99ce-a1882afeef23","migrationVersion":{"visualization":"7.4.2"},"references":[],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzMxLDFd"}
{"attributes":{"fields":"[{\"name\":\"_id\",\"type\":\"string\",\"esTypes\":[\"_id\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"_index\",\"type\":\"string\",\"esTypes\":[\"_index\"],\"count\":3,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"_score\",\"type\":\"number\",\"count\":0,\"scripted\":false,\"searchable\":false,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"_source\",\"type\":\"_source\",\"esTypes\":[\"_source\"],\"count\":0,\"scripted\":false,\"searchable\":false,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"_type\",\"type\":\"string\",\"esTypes\":[\"_type\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"processing_timeout\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"kind\",\"type\":\"string\",\"esTypes\":[\"text\"],\"count\":2,\"scripted\":false,\"searchable\":true,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"kind.keyword\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"parent\":\"kind\",\"subType\":\"multi\"},{\"name\":\"last_claimed.claimed_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":1,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"last_claimed.last_report.at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"last_claimed.result.at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":1,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"last_claimed.times_out_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"last_claimed.worker_id\",\"type\":\"string\",\"esTypes\":[\"text\"],\"count\":1,\"scripted\":false,\"searchable\":true,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"last_claimed.worker_id.keyword\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"parent\":\"last_claimed.worker_id\",\"subType\":\"multi\"},{\"name\":\"last_enqueued_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"metadata.created_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"metadata.modified_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"priority\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"remaining_attempts\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":1,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"retry_times\",\"type\":\"number\",\"esTypes\":[\"long\"],\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"count\":2},{\"name\":\"run_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"count\":4},{\"name\":\"state\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":2,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true}]","timeFieldName":"metadata.created_at","title":".tasques_queue-*"},"id":".tasques_queue-*","migrationVersion":{"index-pattern":"6.5.0"},"references":[],"type":"index-pattern","updated_at":"2020-02-27T05:00:09.702Z","version":"WzMyLDFd"}
{"attributes":{"columns":["_index","kind","state"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"query\":{\"match\":{\"state\":{\"query\":\"queued\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"state\",\"params\":{\"query\":\"queued\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}},{\"range\":{\"run_at\":{\"gt\":\"now\"}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"type\":\"range\",\"disabled\":false,\"negate\":false,\"alias\":null,\"key\":\"run_at\",\"params\":{\"gt\":\"now\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state scheduled","version":1},"id":"b94e5520-4baf-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzMzLDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state scheduled","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state scheduled\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"d6924960-4bb0-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"b94e5520-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM0LDFd"}
{"attributes":{"columns":["_index","kind","state","run_at"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"query\":{\"match\":{\"state\":{\"query\":\"queued\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"state\",\"params\":{\"query\":\"queued\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}},{\"range\":{\"run_at\":{\"lt\":\"now\"}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"range\",\"key\":\"run_at\",\"params\":{\"lt\":\"now\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state queued","version":1},"id":"9ab27c90-4baf-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM1LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state queued","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state queued\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"6d2e2750-4bb0-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"9ab27c90-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM2LDFd"}
{"attributes":{"columns":["_index","kind","state"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"query\":{\"match\":{\"state\":{\"query\":\"claimed\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"state\",\"params\":{\"query\":\"claimed\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state claimed","version":1},"id":"ef32b820-4baf-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM3LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state claimed","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state claimed\",\"type\":\"metric\",\"params\":{\"addLegend\":false,\"addTooltip\":true,\"metric\":{\"colorSchema\":\"Green to Red\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"invertColors\":false,\"labels\":{\"show\":true},\"metricColorMode\":\"None\",\"percentageMode\":false,\"style\":{\"bgColor\":false,\"bgFill\":\"#000\",\"fontSize\":60,\"labelColor\":false,\"subText\":\"\"},\"useRanges\":false},\"type\":\"metric\"},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"4ec608f0-4bb0-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"ef32b820-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM4LDFd"}
{"attributes":{"columns":["_index","kind","state","run_at","retry_times"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"$state\":{\"store\":\"appState\"},\"query\":{\"match\":{\"state\":{\"query\":\"failed\",\"type\":\"phrase\"}}},\"meta\":{\"alias\":null,\"disabled\":false,\"key\":\"state\",\"negate\":false,\"params\":{\"query\":\"failed\"},\"type\":\"phrase\",\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}},{\"$state\":{\"store\":\"appState\"},\"range\":{\"remaining_attempts\":{\"gte\":1,\"lt\":null}},\"meta\":{\"alias\":null,\"disabled\":false,\"key\":\"remaining_attempts\",\"negate\":false,\"params\":{\"gte\":1,\"lt\":null},\"type\":\"range\",\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state will retry","version":1},"id":"773184d0-4bb1-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[1].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzM5LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state will retry","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state will retry\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"97008630-4bb1-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"773184d0-4bb1-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQwLDFd"}
{"attributes":{"columns":["_index","kind","state"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"query\":{\"match\":{\"state\":{\"query\":\"done\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"state\",\"params\":{\"query\":\"done\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state done","version":1},"id":"d7741350-4baf-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQxLDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state done","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state done\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"62089b80-4bb0-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"d7741350-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQyLDFd"}
{"attributes":{"columns":["_index","kind","state"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[{\"query\":{\"match\":{\"state\":{\"query\":\"dead\",\"type\":\"phrase\"}}},\"$state\":{\"store\":\"appState\"},\"meta\":{\"alias\":null,\"negate\":false,\"disabled\":false,\"type\":\"phrase\",\"key\":\"state\",\"params\":{\"query\":\"dead\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}}]}"},"sort":[["metadata.created_at","desc"]],"title":"Tasques state dead","version":1},"id":"ccf6d570-4baf-11ea-af96-13f8175a2060","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"},{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQzLDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"filter\":[]}"},"savedSearchRefName":"search_0","title":"Tasques state dead","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques state dead\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"58d4a680-4bb0-11ea-af96-13f8175a2060","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":"ccf6d570-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ0LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[]}"},"title":"Tasques total","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques total\",\"type\":\"metric\",\"params\":{\"addTooltip\":true,\"addLegend\":false,\"type\":\"metric\",\"metric\":{\"percentageMode\":false,\"useRanges\":false,\"colorSchema\":\"Green to Red\",\"metricColorMode\":\"None\",\"colorsRange\":[{\"from\":0,\"to\":10000}],\"labels\":{\"show\":true},\"invertColors\":false,\"style\":{\"bgFill\":\"#000\",\"bgColor\":false,\"labelColor\":false,\"subText\":\"\",\"fontSize\":60}}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}}]}"},"id":"b8e6cd10-4b28-11ea-99ce-a1882afeef23","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ1LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[]}"},"title":"Tasques per Queue by state over create time","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques per Queue by state over create time\",\"type\":\"line\",\"params\":{\"addLegend\":true,\"addTimeMarker\":false,\"addTooltip\":true,\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"labels\":{\"filter\":true,\"show\":true,\"truncate\":100},\"position\":\"bottom\",\"scale\":{\"type\":\"linear\"},\"show\":true,\"style\":{},\"title\":{},\"type\":\"category\"}],\"dimensions\":{\"x\":{\"accessor\":0,\"format\":{\"id\":\"date\",\"params\":{\"pattern\":\"HH:mm:ss\"}},\"params\":{\"date\":true,\"interval\":\"PT30S\",\"intervalESValue\":30,\"intervalESUnit\":\"s\",\"format\":\"HH:mm:ss\",\"bounds\":{\"min\":\"2020-02-10T02:28:21.421Z\",\"max\":\"2020-02-10T02:43:21.421Z\"}},\"aggType\":\"date_histogram\"},\"y\":[{\"accessor\":3,\"format\":{\"id\":\"number\"},\"params\":{},\"aggType\":\"count\"}],\"series\":[{\"accessor\":1,\"format\":{\"id\":\"terms\",\"params\":{\"id\":\"string\",\"otherBucketLabel\":\"Other\",\"missingBucketLabel\":\"Missing\"}},\"params\":{},\"aggType\":\"terms\"},{\"accessor\":2,\"format\":{\"id\":\"terms\",\"params\":{\"id\":\"string\",\"otherBucketLabel\":\"Other\",\"missingBucketLabel\":\"Missing\"}},\"params\":{},\"aggType\":\"terms\"}]},\"grid\":{\"categoryLines\":false},\"labels\":{},\"legendPosition\":\"right\",\"seriesParams\":[{\"drawLinesBetweenPoints\":true,\"interpolate\":\"step-after\",\"lineWidth\":2,\"mode\":\"normal\",\"show\":true,\"showCircles\":true,\"valueAxis\":\"ValueAxis-1\",\"type\":\"histogram\",\"data\":{\"id\":\"1\",\"label\":\"Count\"}}],\"thresholdLine\":{\"color\":\"#34130C\",\"show\":false,\"style\":\"full\",\"value\":10,\"width\":1},\"times\":[],\"type\":\"line\",\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"labels\":{\"filter\":false,\"rotate\":0,\"show\":true,\"truncate\":100},\"name\":\"LeftAxis-1\",\"position\":\"left\",\"scale\":{\"mode\":\"normal\",\"type\":\"linear\"},\"show\":true,\"style\":{},\"title\":{\"text\":\"Count\"},\"type\":\"value\"}]},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"schema\":\"segment\",\"params\":{\"field\":\"metadata.created_at\",\"timeRange\":{\"from\":\"now-15m\",\"to\":\"now\"},\"useNormalizedEsInterval\":true,\"scaleMetricValues\":false,\"interval\":\"auto\",\"drop_partials\":false,\"min_doc_count\":1,\"extended_bounds\":{},\"customLabel\":\"Created at\"}},{\"id\":\"3\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"group\",\"params\":{\"field\":\"_index\",\"orderBy\":\"_key\",\"order\":\"desc\",\"size\":9,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\"}},{\"id\":\"4\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"group\",\"params\":{\"field\":\"state\",\"orderBy\":\"_key\",\"order\":\"desc\",\"size\":10,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\"}}]}"},"id":"af82a9c0-4a4b-11ea-89d9-d103b0c26286","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ2LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"filter\":[{\"$state\":{\"store\":\"appState\"},\"query\":{\"match\":{\"state\":{\"query\":\"done\",\"type\":\"phrase\"}}},\"meta\":{\"alias\":null,\"disabled\":false,\"key\":\"state\",\"negate\":false,\"params\":{\"query\":\"done\"},\"type\":\"phrase\",\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index\"}}]}"},"savedSearchRefName":"search_0","title":"Tasques successful workers","uiStateJSON":"{\"vis\":{\"defaultColors\":{\"0 - 4\":\"rgb(247,252,245)\",\"4 - 8\":\"rgb(233,247,228)\",\"8 - 12\":\"rgb(211,238,205)\",\"12 - 16\":\"rgb(184,227,177)\",\"16 - 20\":\"rgb(152,213,148)\",\"20 - 24\":\"rgb(116,196,118)\",\"24 - 28\":\"rgb(75,176,98)\",\"28 - 32\":\"rgb(47,152,79)\",\"32 - 36\":\"rgb(21,127,59)\",\"36 - 40\":\"rgb(0,100,40)\"}}}","version":1,"visState":"{\"title\":\"Tasques successful workers\",\"type\":\"heatmap\",\"params\":{\"addLegend\":true,\"addTooltip\":true,\"colorSchema\":\"Greens\",\"colorsNumber\":10,\"colorsRange\":[],\"dimensions\":{\"series\":[{\"accessor\":0,\"aggType\":\"terms\",\"format\":{\"id\":\"terms\",\"params\":{\"id\":\"string\",\"missingBucketLabel\":\"Missing\",\"otherBucketLabel\":\"Other\"}},\"params\":{}}],\"x\":{\"accessor\":1,\"aggType\":\"terms\",\"format\":{\"id\":\"terms\",\"params\":{\"id\":\"string\",\"missingBucketLabel\":\"Missing\",\"otherBucketLabel\":\"Other\"}},\"params\":{}},\"y\":[{\"accessor\":2,\"aggType\":\"count\",\"format\":{\"id\":\"number\"},\"params\":{}}]},\"enableHover\":true,\"invertColors\":false,\"legendPosition\":\"right\",\"percentageMode\":false,\"setColorRange\":false,\"times\":[],\"type\":\"heatmap\",\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"labels\":{\"color\":\"black\",\"overwriteColor\":false,\"rotate\":0,\"show\":false},\"scale\":{\"defaultYExtents\":false,\"type\":\"linear\"},\"show\":false,\"type\":\"value\"}]},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"group\",\"params\":{\"field\":\"last_claimed.worker_id.keyword\",\"orderBy\":\"1\",\"order\":\"desc\",\"size\":30,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\"}},{\"id\":\"3\",\"enabled\":true,\"type\":\"terms\",\"schema\":\"segment\",\"params\":{\"field\":\"_index\",\"orderBy\":\"1\",\"order\":\"desc\",\"size\":5,\"otherBucket\":false,\"otherBucketLabel\":\"Other\",\"missingBucket\":false,\"missingBucketLabel\":\"Missing\",\"customLabel\":\"Queue\"}}]}"},"id":"1a3ccd10-560c-11ea-9e85-555dcc89eff1","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.filter[0].meta.index","type":"index-pattern"},{"id":"d7741350-4baf-11ea-af96-13f8175a2060","name":"search_0","type":"search"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ3LDFd"}
{"attributes":{"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"filter\":[]}"},"optionsJSON":"{\"hidePanelTitles\":false,\"useMargins\":true}","panelsJSON":"[{\"version\":\"7.5.2\",\"gridData\":{\"x\":0,\"y\":0,\"w\":12,\"h\":9,\"i\":\"92b5fd79-4c7f-4d11-84d2-c9c5f1690bb9\"},\"panelIndex\":\"92b5fd79-4c7f-4d11-84d2-c9c5f1690bb9\",\"embeddableConfig\":{\"title\":\"\"},\"panelRefName\":\"panel_0\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":12,\"y\":0,\"w\":6,\"h\":9,\"i\":\"1bd218e0-ae5d-455c-9a75-a7b912c99424\"},\"panelIndex\":\"1bd218e0-ae5d-455c-9a75-a7b912c99424\",\"embeddableConfig\":{\"title\":\"Scheduled\"},\"title\":\"Scheduled\",\"panelRefName\":\"panel_1\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":18,\"y\":0,\"w\":6,\"h\":9,\"i\":\"ed1321cb-f2ea-4ae3-bb71-86965b9df9c1\"},\"panelIndex\":\"ed1321cb-f2ea-4ae3-bb71-86965b9df9c1\",\"embeddableConfig\":{\"title\":\"Queued\"},\"title\":\"Queued\",\"panelRefName\":\"panel_2\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":24,\"y\":0,\"w\":6,\"h\":9,\"i\":\"391807f0-bdca-4ee9-975f-5aa2da7583d9\"},\"panelIndex\":\"391807f0-bdca-4ee9-975f-5aa2da7583d9\",\"embeddableConfig\":{\"title\":\"Processing\"},\"title\":\"Processing\",\"panelRefName\":\"panel_3\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":30,\"y\":0,\"w\":6,\"h\":9,\"i\":\"15dfad76-a493-48ae-b27d-fc076754f7de\"},\"panelIndex\":\"15dfad76-a493-48ae-b27d-fc076754f7de\",\"embeddableConfig\":{\"title\":\"Will retry\"},\"title\":\"Will retry\",\"panelRefName\":\"panel_4\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":36,\"y\":0,\"w\":6,\"h\":9,\"i\":\"7c12e17a-7199-4e1a-b693-8e124e2c01c2\"},\"panelIndex\":\"7c12e17a-7199-4e1a-b693-8e124e2c01c2\",\"embeddableConfig\":{\"title\":\"Done\"},\"title\":\"Done\",\"panelRefName\":\"panel_5\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":42,\"y\":0,\"w\":6,\"h\":9,\"i\":\"35178073-0bac-46a3-b0ae-eabf84d82240\"},\"panelIndex\":\"35178073-0bac-46a3-b0ae-eabf84d82240\",\"embeddableConfig\":{\"title\":\"Dead\"},\"title\":\"Dead\",\"panelRefName\":\"panel_6\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":0,\"y\":9,\"w\":12,\"h\":16,\"i\":\"a45ad320-4f4b-4b5c-9c42-bd4aa26164cb\"},\"panelIndex\":\"a45ad320-4f4b-4b5c-9c42-bd4aa26164cb\",\"embeddableConfig\":{\"title\":\"Total\"},\"title\":\"Total\",\"panelRefName\":\"panel_7\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":12,\"y\":9,\"w\":36,\"h\":16,\"i\":\"ff52b547-97cf-4c68-9591-38ea7bec3dd7\"},\"panelIndex\":\"ff52b547-97cf-4c68-9591-38ea7bec3dd7\",\"embeddableConfig\":{},\"panelRefName\":\"panel_8\"},{\"version\":\"7.5.2\",\"gridData\":{\"x\":0,\"y\":25,\"w\":48,\"h\":20,\"i\":\"14d94d23-0643-4c7c-9703-408f6c399d78\"},\"panelIndex\":\"14d94d23-0643-4c7c-9703-408f6c399d78\",\"embeddableConfig\":{\"title\":\"Worker completions\"},\"title\":\"Worker completions\",\"panelRefName\":\"panel_9\"}]","timeRestore":false,"title":"tasques","version":1},"id":"b241e240-4a76-11ea-89d9-d103b0c26286","migrationVersion":{"dashboard":"7.3.0"},"references":[{"id":"eff223e0-4b28-11ea-99ce-a1882afeef23","name":"panel_0","type":"visualization"},{"id":"d6924960-4bb0-11ea-af96-13f8175a2060","name":"panel_1","type":"visualization"},{"id":"6d2e2750-4bb0-11ea-af96-13f8175a2060","name":"panel_2","type":"visualization"},{"id":"4ec608f0-4bb0-11ea-af96-13f8175a2060","name":"panel_3","type":"visualization"},{"id":"97008630-4bb1-11ea-af96-13f8175a2060","name":"panel_4","type":"visualization"},{"id":"62089b80-4bb0-11ea-af96-13f8175a2060","name":"panel_5","type":"visualization"},{"id":"58d4a680-4bb0-11ea-af96-13f8175a2060","name":"panel_6","type":"visualization"},{"id":"b8e6cd10-4b28-11ea-99ce-a1882afeef23","name":"panel_7","type":"visualization"},{"id":"af82a9c0-4a4b-11ea-89d9-d103b0c26286","name":"panel_8","type":"visualization"},{"id":"1a3ccd10-560c-11ea-9e85-555dcc89eff1","name":"panel_9","type":"visualization"}],"type":"dashboard","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ4LDFd"}
{"attributes":{"fields":"[{\"name\":\"_id\",\"type\":\"string\",\"esTypes\":[\"_id\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"_index\",\"type\":\"string\",\"esTypes\":[\"_index\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"_score\",\"type\":\"number\",\"count\":0,\"scripted\":false,\"searchable\":false,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"_source\",\"type\":\"_source\",\"esTypes\":[\"_source\"],\"count\":0,\"scripted\":false,\"searchable\":false,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"_type\",\"type\":\"string\",\"esTypes\":[\"_type\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":false},{\"name\":\"is_deleted\",\"type\":\"boolean\",\"esTypes\":[\"boolean\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"loaded_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"metadata.created_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"metadata.modified_at\",\"type\":\"date\",\"esTypes\":[\"date\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"schedule_expression\",\"type\":\"string\",\"esTypes\":[\"text\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"schedule_expression.keyword\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"parent\":\"schedule_expression\",\"subType\":\"multi\"},{\"name\":\"task_definition.kind\",\"type\":\"string\",\"esTypes\":[\"text\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"task_definition.kind.keyword\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"parent\":\"task_definition.kind\",\"subType\":\"multi\"},{\"name\":\"task_definition.priority\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"task_definition.processing_timeout\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true},{\"name\":\"task_definition.queue\",\"type\":\"string\",\"esTypes\":[\"text\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":false,\"readFromDocValues\":false},{\"name\":\"task_definition.queue.keyword\",\"type\":\"string\",\"esTypes\":[\"keyword\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true,\"parent\":\"task_definition.queue\",\"subType\":\"multi\"},{\"name\":\"task_definition.retry_times\",\"type\":\"number\",\"esTypes\":[\"long\"],\"count\":0,\"scripted\":false,\"searchable\":true,\"aggregatable\":true,\"readFromDocValues\":true}]","timeFieldName":"metadata.created_at","title":".tasques_recurring_tasks"},"id":".tasques_recurring_tasks","migrationVersion":{"index-pattern":"6.5.0"},"references":[],"type":"index-pattern","updated_at":"2020-02-27T06:31:04.457Z","version":"Wzg5LDFd"}
{"attributes":{"columns":["_id","_index","kind","state","run_at","last_claimed.claimed_at","last_claimed.result.at"],"description":"","hits":0,"kibanaSavedObjectMeta":{"searchSourceJSON":"{\"highlightAll\":true,\"version\":true,\"query\":{\"language\":\"kuery\",\"query\":\"\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[]}"},"sort":[["metadata.created_at","desc"]],"title":".tasques_queues","version":1},"id":"39800260-4a49-11ea-89d9-d103b0c26286","migrationVersion":{"search":"7.4.0"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"search","updated_at":"2020-02-27T05:00:09.702Z","version":"WzQ5LDFd"}
{"attributes":{"description":"","kibanaSavedObjectMeta":{"searchSourceJSON":"{\"query\":{\"query\":\"\",\"language\":\"kuery\"},\"indexRefName\":\"kibanaSavedObjectMeta.searchSourceJSON.index\",\"filter\":[]}"},"title":"Tasques State vs CreatedAt","uiStateJSON":"{}","version":1,"visState":"{\"title\":\"Tasques State vs CreatedAt\",\"type\":\"histogram\",\"params\":{\"type\":\"histogram\",\"grid\":{\"categoryLines\":false},\"categoryAxes\":[{\"id\":\"CategoryAxis-1\",\"type\":\"category\",\"position\":\"bottom\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\"},\"labels\":{\"show\":true,\"filter\":true,\"truncate\":100},\"title\":{}}],\"valueAxes\":[{\"id\":\"ValueAxis-1\",\"name\":\"LeftAxis-1\",\"type\":\"value\",\"position\":\"left\",\"show\":true,\"style\":{},\"scale\":{\"type\":\"linear\",\"mode\":\"normal\"},\"labels\":{\"show\":true,\"rotate\":0,\"filter\":false,\"truncate\":100},\"title\":{\"text\":\"Count\"}}],\"seriesParams\":[{\"show\":true,\"type\":\"histogram\",\"mode\":\"stacked\",\"valueAxis\":\"ValueAxis-1\",\"drawLinesBetweenPoints\":true,\"lineWidth\":2,\"showCircles\":true,\"data\":{\"label\":\"Count\",\"id\":\"1\"}}],\"addTooltip\":true,\"addLegend\":true,\"legendPosition\":\"right\",\"times\":[],\"addTimeMarker\":false,\"labels\":{\"show\":false},\"thresholdLine\":{\"show\":false,\"value\":10,\"width\":1,\"style\":\"full\",\"color\":\"#34130C\"},\"dimensions\":{\"x\":{\"accessor\":0,\"format\":{\"id\":\"date\",\"params\":{\"pattern\":\"HH:mm:ss\"}},\"params\":{\"date\":true,\"interval\":\"PT30S\",\"intervalESValue\":30,\"intervalESUnit\":\"s\",\"format\":\"HH:mm:ss\",\"bounds\":{\"min\":\"2020-02-09T05:48:54.769Z\",\"max\":\"2020-02-09T06:03:54.769Z\"}},\"aggType\":\"date_histogram\"},\"y\":[{\"accessor\":3,\"format\":{\"id\":\"number\"},\"params\":{},\"aggType\":\"count\"}],\"series\":[{\"accessor\":1,\"format\":{\"id\":\"string\"},\"params\":{},\"aggType\":\"significant_terms\"},{\"accessor\":2,\"format\":{\"id\":\"string\"},\"params\":{},\"aggType\":\"significant_terms\"}]}},\"aggs\":[{\"id\":\"1\",\"enabled\":true,\"type\":\"count\",\"schema\":\"metric\",\"params\":{}},{\"id\":\"2\",\"enabled\":true,\"type\":\"date_histogram\",\"schema\":\"segment\",\"params\":{\"field\":\"metadata.created_at\",\"timeRange\":{\"from\":\"now-15m\",\"to\":\"now\"},\"useNormalizedEsInterval\":true,\"scaleMetricValues\":false,\"interval\":\"auto\",\"drop_partials\":false,\"min_doc_count\":1,\"extended_bounds\":{}}},{\"id\":\"5\",\"enabled\":true,\"type\":\"significant_terms\",\"schema\":\"group\",\"params\":{\"field\":\"state\",\"size\":10}}]}"},"id":"0de746e0-4b02-11ea-99ce-a1882afeef23","migrationVersion":{"visualization":"7.4.2"},"references":[{"id":".tasques_queue-*","name":"kibanaSavedObjectMeta.searchSourceJSON.index","type":"index-pattern"}],"type":"visualization","updated_at":"2020-02-27T05:00:09.702Z","version":"WzUwLDFd"}
{"exportedCount":22,"missingRefCount":0,"missingReferences":[]}`

// Importer, when run imports Tasques-specific Kibana Saved Objects
type Importer struct {
	conf       config.KibanaClient
	httpClient *http.Client
}

// NewImporter returns a new Importer
func NewImporter(conf config.KibanaClient, httpClient *http.Client) Importer {
	return Importer{
		conf:       conf,
		httpClient: httpClient,
	}
}

// Run kicks off the importing
func (i *Importer) Run(ctx context.Context) error {
	body := &bytes.Buffer{}
	writer := multipart.NewWriter(body)
	part, err := writer.CreateFormFile("file", "tasques_saved_objects.ndjson")
	if err != nil {
		return RequestPrepErr{underlying: err}
	}
	_, err = io.Copy(part, strings.NewReader(ndjson))
	if err != nil {
		return RequestPrepErr{underlying: err}
	}
	err = writer.Close()
	if err != nil {
		return RequestPrepErr{underlying: err}
	}

	req, err := http.NewRequestWithContext(
		ctx,
		http.MethodPost,
		fmt.Sprintf("%s/api/saved_objects/_import?overwrite=true", i.conf.Address),
		body,
	)
	if err != nil {
		return RequestPrepErr{underlying: err}
	}
	req.Header.Set("Content-Type", writer.FormDataContentType())
	req.Header.Add("kbn-xsrf", "true")

	if i.conf.User != nil {
		req.SetBasicAuth(i.conf.User.Name, i.conf.User.Password)
	}
	resp, err := i.httpClient.Do(req)

	if err != nil {
		return fmt.Errorf("Error sending request [%w]", err)
	}
	defer req.Body.Close()

	switch resp.StatusCode {
	case 200:
		var kibResp kibanaResponse
		if err := json.NewDecoder(resp.Body).Decode(&kibResp); err != nil {
			return common.JsonSerdesErr{Underlying: []error{err}}
		}
		if kibResp.Success {
			return nil
		} else {
			return KibanaResponseErr{underlying: fmt.Errorf("Unsuccessful response from Kibana [%v]", kibResp)}
		}
	default:
		return KibanaResponseErr{underlying: fmt.Errorf("Unexpected response from Kibana. Status [%d] %v", resp.StatusCode, resp.Status)}
	}
}

type kibanaResponse struct {
	Success bool `json:"success"`
}

// <-- Errors

type RequestPrepErr struct {
	underlying error
}

func (r RequestPrepErr) Error() string {
	return fmt.Sprintf("Error preparing HTTP request: [%s]", r.underlying.Error())
}

type KibanaResponseErr struct {
	underlying error
}

func (k KibanaResponseErr) Error() string {
	return fmt.Sprintf("Kibana replied with an error. Reason [%s]", k.underlying)
}

// Errors -->
